---
title: 防火墙
date: 2021-11-12 16:48:32
tags: 计算机网络
categories: 计算机网络
---

# 防火墙

## 特征

- 逻辑区域过滤器
- 隐藏内网网络结构
- 自身安全保障
- 主动防御攻击

## 分类

- 包过滤防火墙（现在网络中基本不存在）
  - 无法关联数据包之间关系
  - 无法适应多通道协议
  - 通常不检查应用层数据

![image-20211112161519040](https://cdn.jsdelivr.net/gh/SC-WSKun/HexoStaticFile/img/image-20211112161519040.png)

- 代理防火墙（基本不用）

![image-20211112161758086](https://cdn.jsdelivr.net/gh/SC-WSKun/HexoStaticFile/img/image-20211112161758086.png)

- 状态监测防火墙（主流）
  - 保存TCP三次握手状态
  - 处理后续包速度快
  - 安全性高

## 防火墙组网方式

### 双机热备

![image-20211112162036817](https://cdn.jsdelivr.net/gh/SC-WSKun/HexoStaticFile/img/image-20211112162036817.png)

## 防火墙转发原理

### 包过滤技术

> 对需要转发的数据包，先获取包头信息，然后和设定的规则进行比较，根据比较的结果对数据包进行转发或者丢弃
>
> 实现包过滤的核心技术是**访问控制列表**

### 防火墙安全策略

> 安全策略是按一定规则控制设备对流量转发以及对流量进行内容安全一体化检测的策略。
>
> 规则的本质是**包过滤**

#### 作用：

- 根据定义的规则对经过防火墙的流量进行筛选，并根据关键字确定筛选出的流量如何进行下一步的操作。

#### 主要应用于：

- 对跨防火墙的网络互访进行控制
- 对设备本身的访问进行控制

![image-20211112162540184](https://cdn.jsdelivr.net/gh/SC-WSKun/HexoStaticFile/img/image-20211112162540184.png)

## 防火墙域间转发

![image-20211112162801648](https://cdn.jsdelivr.net/gh/SC-WSKun/HexoStaticFile/img/image-20211112162801648.png)

## 状态检测机制

- 开启时：只有首包通过设备才能建立会话表项，后续包直接匹配会话表项进行转发
- 关闭时：首包没有通过设备，后续包只要通过设备也可以生成会话表

## 会话表项

| 源IP地址 | 源端口 | 目的IP地址 | 目的端口 | 协议 | 用户 | 应用 |
| -------- | ------ | ---------- | -------- | ---- | ---- | ---- |
|          |        |            |          |      |      |      |

### 查看会话表信息

```
display firewall session table (verbose)是否详细
```

## 安全策略匹配流程

![image-20211112163536998](https://cdn.jsdelivr.net/gh/SC-WSKun/HexoStaticFile/img/image-20211112163536998.png)

## 配置安全策略

![image-20211112164333921](https://cdn.jsdelivr.net/gh/SC-WSKun/HexoStaticFile/img/image-20211112164333921.png)

### 配置安全区域（WEB）

- 系统默认已经创建了四个安全区域。可以自行创建更多的安全等级。但是与默认的安全区域的安全级别不能相等，要保证唯一性。

### 配置地址和地址组

### 配置服务和服务组

### 配置应用和应用组

### 配置时间段

配置安全策略可以引用刚才已经创建好的对象

## ASPF技术

> ASPF是一种高级通信过滤，它检查应用层协议信息并且监控连接的应用层协议状态。对于特定应用协议的所有连接，每一个连接状态信息都将被ASPF维护并用于动态的决定数据包是否被允许通过防火墙或丢弃

简单来说，ASPF是用来给防火墙提供一种获得使用不确定端口的通信协议时的具体端口的方法，通过将端口信息放在应用层数据，发送给防火墙后，在SeverMap表中会有这个新的端口号，这样就能让包顺利通过。

### 多通道协议技术

- 单通道协议：通信过程中只需占用一个端口的协议。如：WWW只需占用80端口。
- 多通道协议：通信过程中需占用两个或两个以上端口的协议。如FTP被动模式下需占用21号端口以及一个随机端口

## Server Map的产生

- 配置ASPF
- 配置NAT服务器映射时生成静态Server-map
- 配置NAT No-PAT时生成动态Server-map

### 端口识别

> 端口识别是把非标准协议端口映射成可识别的应用协议端口

## 分片缓存

分片缓存功能用来缓存先于首片分片报文到达的后续分片报文，避免分片报文丢弃。

## 长连接

需要长连接的原因，

- 防火墙会话表老化机制
- 会话老化机制给特殊业务带来的问题

## 双机热备技术

> 传统的组网如果防火墙出现故障，则所有以防火墙作为默认网关的主机与外部网络之间的通讯将中断，只有一个防火墙通讯可靠性无法保证

参考路由器组网中的VRRP协议实现设备冗余的方式

- 传统VRRP方式无法实现主、备用防火墙状态的一致性

### VGMP

> 所以在VRRP的基础上进行扩展，推出VGMP来弥补局限，实现了状态组的统一切换，但是会话表无法同步，可能导致首包没有经过备用防火墙的包被阻塞

状态有：

Active/Standby，组内所有VRRP备份组的状态统一

- Active：会定期向对端发送Hello报文，通知Standby端本身的运行状态（包括优先级、VRRP成员状态）

作用：

- 状态一致性管理
- 抢占管理

![image-20211113001010128](https://cdn.jsdelivr.net/gh/SC-WSKun/HexoStaticFile/img/image-20211113001010128.png)

### HRP

> （Huawei Redundancy Protocol）华为冗余备份协议，用来实现防火墙双机之间动态状态数据和关键配置命令的备份

需要等会话建立才会将会话同步，如果在会话建立前就切换的话需要用到下面的会话快速备份

### HRP心跳接口

心跳口必须是状态独立且具有IP地址的接口，可以是物理接口，也可以捆绑在一个组成一个逻辑接口

五种状态：

- Invalid
- Down
- Peerdown
- Ready
- running

### 备份方式

- 自动备份
- 手工批量备份
- 设备重启后主备防火墙的配置自动同步
- 会话快速备份

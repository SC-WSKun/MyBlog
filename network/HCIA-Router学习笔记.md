---
title: HCIA-Router学习笔记
date: 2021-09-28 20:22:10
tags: 计算机网络
categories: 计算机网络 
---

# 数据通信网络基础

## 通信与网络

1. 网络通信基本概念

- 通信：人与人、人与物、物与物之间通过某种媒介和行为进行的信息传递与交流
- 网络通信：终端设备之间通过计算机网络进行的通信
- 常见术语
  ```
  数据载荷：最终想要传递的信息
  报文：网络中交换与传输的数据单元
  头部：在数据载荷的前面添加的信息段
  尾部：在数据载荷的后面添加的信息段
  封装：对数据载荷添加头部和尾部，获取数据载荷的过程
  解封装：去掉报文的头部和尾部，获取数据载荷的过程
  网关：提供协议转换、路由选择、数据交换等功能的功能
  路由器：为报文选择传递路径的网络设备
  终端设备：数据通信系统的端设备，作为数据的发送者或接收者
  ```
- 数据通信网络：

  由路由器、交换机、防火墙、无线控制器、无线接入点，以及个人电脑、网络打印机、服务器等设备构成的通信网络

  功能：实现数据互通

- 交换机：
  ```
  距离终端用户最近的设备，用于终端用户接入网络、对数据帧进行交换等。
  终端设备的网络接入
  二层交换
  ```
- 路由器：
  ```
  定义：
  网络层设备，可以在因特网中进行数据报文转发。路由器根据所收到的报文的目的地址选择一条合适的路径，将报文传送到下一个路由器或目的地，路径中最后的路由器负责将报文送交目的主机
  功能：
  实现同类型网络或异种网络之间的通信
  隔离广播域
  维护路由表
  运行路由协议
  路径选择、IP报文转发
  广域网接入、网络地址转换
  连接通过交换机组建的二层网络
  ```
- 防火墙：
  ```
  定义：
  网络安全设备，用于控制两个网络之间的安全通信。它通过检测、限制、更改跨越防火墙的数据流，尽可能地对外部屏蔽网络内部的信息、结构和运行状况，以此来实现对网络的安全保护
  功能：
  隔离不同安全级别的网络
  实现不同安全级别网络间的访问控制（安全策略）
  用户身份认证
  实现远程接入功能
  实现数据加密及虚拟专用网业务
  执行网络地址转换
  其他安全功能
  ```
- 无线设备
  ```
    无线瘦AP
    无线胖AP
  ```

## 网络类型与网络拓扑

### 网络拓扑

- 网络拓扑
  ```
  用传输介质（例如双绞线、光纤等）互连各种设备所呈现的结构化布局
  ```
- 网络拓扑形态
  ```
  星型网络
  总线型网络
  环形网络
  树形网络
  全网状网络
  部分网状网络
  ```

## 网络工程与网络工程师

### 网络工程

在信息系统工程方法和完善的组织机构指导下，根据网络应用的需求，按照计算机网络系统的标准、规范和技术，规划设计可行性方案，**将计算机网络硬件设备、软件和技术系统地集成在一起，以成为满足用户需求、高性价比的网络系统**的组建工作

### 网络工程师

成长过程：

宏观->微观

这是什么->这怎么用（配置，查看）->协议机制->报文及底层（协议的底层工作机制）->规施排优（规划实施排错优化）

# 网络参考模型

## 应用与数据

- 应用：满足人们的需求，可以生产数据
- 数据：数据是信息的载体
- 数据传输：大部分应用程序所产生的数据需要在不同的设备之间传递

## 网络参考模型

- OSI 参考模型
  ```
  7. 应用层
  6. 表示层
  5. 会话层
  4. 传输层
  3. 网络层
  2. 数据链路层
  1. 物理层
  ```
- TCP/IP 标准模型
  ```
  4. 应用层
  3. 主机到主机层
  2. 因特网层
  1. 网络接入层
  ```
- TCP/IP 对等模型
  ```
  5. 应用层：为应用软件提供接口，使应用程序能够使用网络服务。应用层协议会指定使用响应的传输层协议，以及传输层所使用的端口等
    HTTP:80，提供一种发布和接收HTML页面的方法
    Telnet:23，数据网络中提供远程登录服务的标准协议
    FTP:20、21，用于从一台主机传送文件到另一台主机的协议，用于文件的“下载”和“上传”，它采用“C/S”架构
    SMTP:25
    TFTP:6
  4. 传输层
    TCP：一种面向连接的、可靠的传输层通信协议
    UDP：一种简单的无连接协议
    TCP三次握手
    确认序列号
    窗口滑动机制
    四次挥手
  3. 网路层
    负责讲分组报文从源主机发送到目的主机
    作用是：
        1. 为网络中的设备提供逻辑地址
        2. 负责数据包的寻径和转发
  2. 数据链路层
    可以向网络层提供服务，PDU称为帧
    作用是：
        数据链路层向网络层提供“段内通信”
        负责组帧、物理编址、差错控制等功能
        常见的数据链路层协议有：以太网、PPPoE、PPP等
  1. 物理层
    将数字信号转换成光信号、电信号或者是电磁波信号，PDU称为比特流
    作用是：
        负责比特流在介质上的传输
        规范了线缆、针脚、电压、接口等物理特性规范
        常见的传输介质有：双绞线、光纤、电磁波等
  ```

## 数据通信过程

- 发送方数据封装
  ```
  应用层
  传输层 增加TCP或者UDP头
  网络层 增加IP头部
  数据链路层 增加以太网头部和校验和
  物理层
  ```
- 中间网络数据传输
  ```
  发送方->交换机（MAC）->路由器（IP）->接收方
  ```
- 接收方数据解封装
  ```
  物理层
  数据链路层 去掉以太网头部
  网络层 去掉IP头部
  传输层 去掉TCP或UDP头
  ```

# 华为 VRP 系统

## 概述

华为公司数据通信产品的通用操作系统平台

### 功能：

1. 实现同一个的用户界面和管理界面
2. 实现控制平面功能，并定义转发平面接口规范
3. 实现各产品转发平面与 VRP 控制平面之间的交互
4. 屏蔽各产品链路层对于网络层的差异

### 文件系统

- 系统文件(.cc)：设备启动、运行的必备软件
- 配置文件(.cfg, .zip, .dat)：保存用户配置命令的文件
- 补丁文件(.pat)：与设备系统软件兼容的文件
- PAF 文件(.bin)

### 存储设备

- SDRAM：同步动态随机存储器
- Flash：非易失存储器
- NVRAM：非易失随机读写存储器
- SD card：断电后，不会丢失数据。存储容量比较大
- USB：接口

## 设备管理方式

- Web 网管方式：图形化操作界面，操作方便直观，但是只能实现部分功能；可以通过 HTTP 和 HTTPS 方式登录
- 命令行方式：使用设备提供的命令行，可以进行精细化管理；通过 Console 口，Telnet 或 SSH 方式登录

### VRP 用户界面

- Console 用户界面：可以直接连接
- VTY 用户界面：要先进行一定配置

### VRP 用户级别

- 参观级：用户等级 0，命令等级 0，可使用网络诊断工具，从本设备访问外部设备的命令
- 监控级：用户等级 1，命令等级 0 and 1，用于系统维护，可使用 display 等命令
- 配置级：用户等级 2，命令级别 0，1 and 2，可使用业务配置命令，包括路由、各个网络层次的命令，向用户提供直接网络服务
- 管理级：用户等级 3，命令级别 0，1，2 and 3，可使用用户系统基本运行的命令，对业务提供支撑作用，包括文件系统、FTP、TFTP 下载、命令级别设置命令以及用户业务故障诊断的 debugging 命令等

### Web 登录

浏览器输入`https://192.168.1.1`

### Putty 登录

- 本地登录：选择 Serial 类型，速率固定为 9600
- 远程登录：选择 SSH 类型（Telnet 类型没有加密，容易被抓包泄露密码），SSH 默认 22 端口，Telnet 默认 23 端口

### 命令行界面 CLI

## 命令行基础

### 基本命令结构

- 命令字
- 关键字
- 参数列表

### 命令行视图

```
用户视图 -> 系统视图 ->接口视图
                    ->协议视图 ->OSPF区域视图
                    ->...
```

- 切换到系统视图：`system-view`
- 切换到接口视图：`interface ...`
- 切换到协议视图：`ospf 1`

### 编辑命令行

- 功能键
- 不完整关键字输入
- tab 键自动补全关键字，如果不唯一可以继续点 tab 循环翻词
- `?`会罗列当前视图下的所有操作，也可以`命令+?`
- 语法检查会在错误的地方加`^`
- 使用 undo 恢复缺省情况、禁用某个功能 或者删除某项配置
- 使用命令行的快捷键
  ```
  CTRL+A 光标移动到当前行的开头
  CTRL+B 光标向左移动一个字符
  CTRL+C 停止当前命令运行
  CTRL+E 将光标移动到当前行的末尾
  CTRL+X 删除光标左侧所有的字符
  CTRL+Y 删除光标所在位置及其右侧所有的字符
  CTRL+Z 返回到用户视图
  CTRL+] 终止当前连接或切换连接
  ```

### 常见文件系统操作命令

- 查看当前目录：`pwd`
- 显示当前目录下的文件信息：`dir`
- 查看文本文件的具体内容：`more`
- 修改用户当前界面的工作目录：`cd`
- 创建新的目录：`mkdir`
- 删除目录：`rmdir`
- 复制文件：`copy`
- 移动文件：`move`
- 重命名文件：`rename`
- 删除文件：`delete`
- 恢复删除的文件：`undelete`
- 彻底删除回收站中的文件：`reset recycle-bin`

### 基本配置命令

- 配置设备名称：`sysname name`
---
- 对本地时区信息进行设置：`clock timezone time-zone-name {add|minus} offset`
- 设置设备当前或 UTC 日期和时间：`clock datetime [utc] HH:MM:SS YYYY-MM-DD`
- 设置设备的夏令时：`clock daylight-saving-time`
---
- 配置命令等级：`command-privilege level ... view ... ...`

- 配置用户通过Password方式登录设备：
  ```
  user-interface vty 0 4
  set authentication password cipher information
  ```
  
- 配置用户界面参数

- 配置接口IP地址：
  ```
  interface 'interface-number'
    ip address 'ip' 'address'
  ```
  
- 查看当前运行的配置文件：`display current-configuration`

- 配置文件保存：`save`

- 查看保存的配置：`display saved-configuration`

- 清除保存的配置：`reset saved-configuration`

- 查看系统启动配置参数：`display startup`

- 重启：`reboot`

  # 以太网

  ## 以太网协议

  > 以太网是当今现有局域网采用的最通用的通信协议标准，定义了局域网中采用的电缆类型和信号处理方法

  以太网是建立在CSMA/CD机制上的广播型网络

  早期的以太网

  ![image-20211015155303482](https://cdn.jsdelivr.net/gh/SC-WSKun/HexoStaticFile/img/image-20211015155303482.png)

交换器组网（增加了交换机来隔离冲突域，但是无法隔离广播域）

![image-20211015155443758](https://cdn.jsdelivr.net/gh/SC-WSKun/HexoStaticFile/img/image-20211015155443758.png)

## 冲突域

> 冲突域是指连接在同一共享介质上所有节点的集合

解决方法：CSMA/CD、隔离冲突域

## 广播域

> 广播报文所能到达的整个访问范围称为二层广播域，简称广播域

## 以太网卡

> 网络接口卡（Network Interface Card，NIC）也称为网卡

计算机的网卡：作用于数据链路层，为网络层提供服务，同时将报文转成01数据流

交换机网卡：根据数据帧中的报文地址进行转发

每个网络接口对应一个网卡

## 以太网帧

两个标准：

1. Ethernet_II格式
2. IEEE 802.3格式

### 单播以太帧

> 目的MAC地址为单播MAC地址的帧

### 广播以太帧

> 目的MAC地址为广播MAC地址的帧

### 组播以太帧

> 目的MAC地址为组播MAC地址的帧

## MAC地址

> MAC地址在网络中唯一标识一个网卡，具有全球唯一性

### 与IP地址的区别

IP地址特点：

1. IP地址是唯一的
2. IP地址可变
3. 基于网络拓扑进行IP地址分配

MAC地址特点：

1. MAC地址是唯一的
2. MAC地址不可变
3. 基于制造商进行MAC地址分配

### MAC地址表示

> 一个MAC地址有48bit，6byte，一般使用十六进制表示

### MAC地址构成

OUI：厂商代码，一般同一个厂商生产的网卡的OUI相同，3Byte，24Bit

制造商分配：3Byte，24bit

### MAC地址分类

单播MAC地址：XXXXXXX0-...

组播MAC地址：XXXXXXX1-...

广播MAC地址：全为1

## 以太网交换机

以太网二层交换机转发数据的端口都是以太端口，并且只能够针对数据的二层头部中的MAC地址进行寻址并转发数据

## 交换机的工作原理

**学习**帧的源MAC地址，然后在MAC地址表中查询该帧的目的MAC地址**转发**

表中没有源MAC记录：添加源MAC地址信息

广播帧、表中没有目的MAC记录（未知单播帧）：除源端口外向外发送请求，**泛洪**

源端口与目的端口相同：**丢弃**报文

## MAC地址表

> 存放了MAC地址与交换机端口编号之间的映射关系

# VLAN（虚拟局域网）

> 用于解决隔离广播域的问题

![image-20211016164804454](https://cdn.jsdelivr.net/gh/SC-WSKun/HexoStaticFile/img/image-20211016164804454.png)

## VLAN标签（802.1QTag）

报文中添加表示VLAN信息的字段使交换机能识别不同的VLAN的报文

打上标签由交换机完成，发出时由交换机添加，接受时由交换机去掉，通常用户无法察觉这一过程

格式：

| TPID（0x8100） | PRI  | CFI  | VLAN ID |
| -------------- | ---- | ---- | ------- |
| 16bit          | 3bit | 1bit | 12bit   |

- TPID：标签协议标识符
- PRI：优先级
- CFI：标准格式指示符
- VLAN ID：1~4094，0跟4095保留

# VLAN的规划

## VLAN分配原则

- 按业务规划
- 按部门规划
- 按应用规划

## VLAN分配技巧

为了提高VLAN ID的连续性，可以采用VLAN ID的连续性，可以采用VLAN ID和子网关联的方式进行分配	

## VLAN的基础命令

1. 创建VLAN：`vlan vlan-id`
2. 批量创建VLAN：`vlan batch {vlan-id1 [to vlan-id2]}`

- Access接口的基础配置命令

  - 配置接口类型：`port link-type access`

  - 配置Access接口的缺省VLAN：`port default vlan vlan-id`

- Trunk接口的基础配置命令

  - 配置接口类型：`port link-type trunk`

  - 配置Access接口的缺省VLAN：`port trunk pvid  vlan vlan-id`

# 生成树

> 用来解决环路问题

## 二层环路问题

> 常见产生原因：二层冗余环境
>
> 解决方案：生成树协议

- 广播风暴
- MAC地址漂移

## 三层环路问题

> 常见原因：路由环路
>
> 解决方法：
>
> - 动态路由协议有一定的防环能力
>
> - IP报文头部中的TTL字段可以防止报文被无尽转发

## 生成树协议

- 能够动态响应网络拓扑变化调整阻塞接口

## STP

### 桥ID

桥ID是每个交换机特有的编号，用来确定优先级，先比较前16个bit，再比较后面的mac地址

| 优先级 | MAC地址 |
| ------ | ------- |
| 16bit  | 48bit   |

优先级越小越优

### Cost

> 每条链路的开销，用于计算根路径开销，即到达根的开销

接口开销与速率、工作模式和STP Cost计算方法有关

接口带宽越大，Cost值越小

用户也可以通过命令调整接口的Cost

开销值最小值为1，只能取整数

### RPC

> 根路径开销，一台设备从某个接口到达根桥的RPC等于从根桥到该设备沿途所有入方向开销之和。

### Port ID

| 接口优先级 | 接口编号 |
| ---------- | -------- |
| 4bit       | 12bit    |

### BPDU

> 桥协议数据单元，是STP的协议报文，用于确定根桥

分类：

- 配置BPDU：确定初始的根桥，是STP进行网络拓扑的关键
- TCN BPDU：只在网络拓扑发生变更时才会触发

| PID  | PVI  | BPDU Type | Flags | Root ID | RPC  | Bridge ID | Port ID | Message Age | Max Age | Hello Time | Forward Delay |
| ---- | ---- | --------- | ----- | ------- | ---- | --------- | ------- | ----------- | ------- | ---------- | ------------- |
|      |      |           |       | 根桥ID  |      |           |         |             |         |            |               |

### 配置BPDU的比较原则

- STP操作：

  1. 选举一个根桥

  2. 每个非根交换机选举一个根端口

  3. 每个网段选举一个指定端口

  4. 阻塞非根、非指定端口

- STP端口角色
  1. 指定端口
  2. 根端口
  3. 预备端口
- STP配置BPDU规则
  1. 最小的根桥ID
  2. 最小的RPC
  3. 最小的网桥ID
  4. 最小的接口ID

### STP的计算过程

1. 根桥选举：

   - 配置BPDU只有根桥可以发送，初始时，所有交换机都认为自己是根桥，因此每个交换机都会发送配置BPDU里面携带自己的桥ID。网络中最小桥ID的交换机成为根桥

   - 根桥是可以抢占的

   - 为了确保交换网络的稳定，应该提前规划好STP组网，并将根桥优先级设为0，防止抢占

2. 根接口选举

   - 根接口是收到最优BPDU的接口

   - 根接口是每台非根桥上“朝向”根桥的接口

3. 指定接口选举

   - 非根桥 会使用在根接口上收到的最优BPDU进行计算，然后将计算得到的配置BPDU与除了根接口之外的其他所有接口所收到的配置BPDU进行比较：如果根接口更优则为指定接口，反之为非指定接口
   - 根桥上的接口一般均为指定接口
4. 阻塞非指定接口

### STP的接口状态

- 禁用：不能收发BPDU，也不能收发业务数据帧
- 阻塞：不能发送BPDU，但是会持续侦听BPDU，而且不能收发业务数据帧，也不会进行MAC地址学习
- 侦听：表明该接口为根接口或者指定接口，但接口依然处于STP计算的过程中，此时可以收发BPDU，但是不能收发业务数据流或者MAC地址学习
- 学习：可以侦听业务数据帧但是不能转发，可以进行MAC地址学习
- 转发：可以正常收发业务数据流，也可以处理BPDU

## 拓扑变化

### 根桥故障

根桥每两秒会发送一次配置BPDU，交换机有一个Max Age计时器（20s），如果超时即得知根桥发生故障。

此时重新选举根桥，非根桥互相发送配置BPDU，选举后需要30s时间恢复转发状态

### 直连链路故障

无需重新选举根桥，只需要经过30s启用备用端口进入转发状态

### 非直连链路发生故障

因为无法直接得知链路故障，需要等老化（20s）后才能重新选举，所以需要50s

 ### 拓扑改变导致MAC地址表错误

> TCN BPDU会在拓扑变化时产生，用于缩短MAC老化时间

拓扑变化时还会有两种特殊的配置BPDU，配置BPDU有两个flag：

- TCA：通知目的交换机已接收目的交换机所发的TCN BPDU，而且会保留根桥的BPDU，通知目的交换机重新计算
- TC：通知交换机刷新MAC地址表

![image-20211018161719420](https://cdn.jsdelivr.net/gh/SC-WSKun/HexoStaticFile/img/image-20211018161719420.png)

## 配置STP

1. 配置生成树工作模式：`stp mode {stp|rstp|mstp}`
2. （可选）配置根桥：
3. （可选）备份根桥：
4. （可选）配置交换机的STP优先级：
5. （可选）配置接口路径开销：

## RSTP

> 对STP的角色进行了扩充，缩减了STP的状态，收敛速度更快，可以兼容STP

状态规范--3种状态

RSTP对于STP的改进：

- 所有交换机都可以发送配置BPDU
- BPDU老化时间从20秒改为6秒
- 端口角色不同：
  - 根端口
  - 指定端口
  - 预备端口
  - 备份端口
  - 边缘端口：处于整个域的边缘，不再与任何交换设备连接，直到这个端口收到配置BPDU
- 端口状态不同：
  - Forwarding
  - Learning
  - Discarding

## MSTP

> STP与RSTP的所有VLAN共享一棵生成树，无法实现流量负载均衡，MSTP基于实例阻塞接口（不是基于VLAN）

- MSTP把一个交换网络划分成多个域，域内形成多棵生成树，生成树之间彼此独立
- 每棵生成树叫做一个多生成树实例
- 生成树实例其实就是多个VLAN集合组成的
- 通过将多个VLAN绑定到一个实例，可以节省通信开销和资源占用率
- 可以把相同拓扑结构的VLAN映射到一个实例里，这些VLAN在接口上的转发状态取决于接口在对应实例中的状态

## VBST

> 分奇偶路线，一个VLAN一棵树

## 一些进阶技术

### 交换机堆叠

> 实现链路聚合，可以将拓扑简化为树形结构，消除二层环路，提高资源利用率

### Smart Link

> 对双上行组网的解决方案，可以在毫秒级切换主端口到备份端口

# IP路由基础

## 路由

> 路由是指导报文转发的路径信息，通过路由可以确认转发IP报文的路径。

- 路由设备是依据路由转发报文到目的网段的网络设备，最常见的路由设备：路由器
- 路由设备维护着一张表，保存着路由信息



### IP路由

| 目的网络/掩码 | 出接口  | 下一跳  |
| ------------- | ------- | ------- |
| 10.1.1.0/24   | GE0/0/0 | 1.1.1.2 |

- 目的网络：标识目的网段
- 掩码：与目的地址共同标识一个网段
- 出接口：数据包被路由后离开本路由器的接口
- 下一跳：路由器转发到达目的网段的数据包所在的下一跳地址

### 路由表

- 路由器通过各种方式发现路由
- 路由器选择最优的路由条目放入路由表中
- 路由表指导设备对IP报文的转发
- 路由器通过对路由表的管理实现对路由消息的管理

| Destination/Mask | Proto | Pre  | Cost | flags | NextHop | Interface |
| ---------------- | ----- | ---- | ---- | ----- | ------- | --------- |
|                  |       |      |      |       |         |           |

## 路由信息获取方式

- 直连路由：

  > 由设备自动生成指向本地直连网络

  - 一般当路由器为路由转发的最后一跳路由器时，IP报文匹配直连路由，路由器转发IP到目的主机
  - 使用直连路由时，报文的目的IP与路由器接口IP在同一个网段
  - 直连路由不一定会出现在路由表中，出现的前提是接口的物理状态、协议状态均为UP

- 静态路由：由网络管理员手工配置的路由条目

- 动态路由：路由器运行动态路由协议学到的路由

## 路由优先级

![image-20211020113829947](https://cdn.jsdelivr.net/gh/SC-WSKun/HexoStaticFile/img/image-20211020113829947.png)

默认优先级：

![image-20211020114005555](https://cdn.jsdelivr.net/gh/SC-WSKun/HexoStaticFile/img/image-20211020114005555.png)

优先级相同时比较度量值：

![image-20211020114846923](https://cdn.jsdelivr.net/gh/SC-WSKun/HexoStaticFile/img/image-20211020114846923.png)

## 路由转发

### 最长匹配原则

> 当路由器收到一个IP数据包时，会将数据包的目的IP地址与自己本地路由表中的所有路由表项进行逐位（Bit-By-Bit）比对，直到找到匹配度最长的条目

## 缺省路由

> 也叫默认路由，当报文没有再路由表中找到匹配的具体路由表项时才使用的路由

- 缺省路由在路由表中的形式为0.0.0.0/0

## 动态路由

> 可以自动发现、学习路由，感知拓扑变更

- 按工作区域分类:
  - IGP(内部网关协议)：
    1. RIP
    2. OSPF
    3. IS-IS
  - EGP(外部网关协议)：
    1. BGP
- 按工作机制及算法分类
  - 距离矢量路由协议
  
    > 运行距离矢量路由协议的路由器周期性的泛洪自己的路由表
    >
    > 对于网络中的所有路由器而言，路由器并不清楚网络的拓扑，只知道目的地址的下一跳在哪里，有多远
  
    1. RIP
  
  - 链路状态路由协议
    
    > 不再通告路由，而是LSA，LSA描述了路由器接口的状态信息，例如接口的开销、连接的对象等
    
    1. OSPF
    2. IS-IS

## 路由高级特性

### 路由递归

非本地直连网络，如果路由表没有去往20.1.1.3的路由，该静态路由将不会生效，无法作为有效路由条目

### 等价路由

> 两个路由条目指向的目的网段相同，但是具有不同的下一跳地址

路由转发会将流量分布到多条路径上

<table>
    <tr>
        <td>目的网络/掩码</td>
        <td>下一跳</td>
    </tr>
    <tr>
    <td rowspan="2">10.0.0.0/30</td>	       <td>20.1.1.2</td>
    </tr>
    <tr>
        <td>30.1.1.2</td>
    </tr>
</table>

路由表中存在等价路由之后，前往该目的网段的IP报文路由器会通过所有有效的接口、下一跳转发，这种转发行为被称为**负载分担**

### 浮动路由

> 有点像做了一个备份，故障时将路由表上的记录切换成备份的。使用优先级来将正常路由与备用路由区分开。

配置命令：

```
ip route-static 20.0.0.0 30 10.1.1.2
ip route-static 20.0.0.0 30 10.1.2.2 preference 70
```

![image-20211020143042842](https://cdn.jsdelivr.net/gh/SC-WSKun/HexoStaticFile/img/image-20211020143042842.png)

### 路由汇总

> 路由汇总采用了CIDR的思想，将一组具有相同前缀的路由汇聚成一条路由，从而达到减小路由表规模以及优化设备资源利用率的目的。

- CIDR

  > CIDR（无类别域间路由）采用IP地址加掩码长度来表示网络和子网

  CIDR容许任意长的掩码长度，可以使用任意长度的前缀分配，该特性可以有效减少路由表条目数量

#### 汇总引发的问题

1. 环路问题

   ![image-20211020152908499](https://cdn.jsdelivr.net/gh/SC-WSKun/HexoStaticFile/img/image-20211020152908499.png)

   解决方法：增加指向Null0的路由

# OSPF

> 为了解决静态路由无法适应规模较大的网络，无法动态响应网络变化

## LSA

>LSA描述了路由器接口的状态信息，例如接口的开销、连接的对象等

## LSDB

> 路由器将LSA存放在LSDB中，LSDB汇总了网络中路由器对于自己接口的描述
>
> LSDB包含全网拓扑的描述，有点像一份地图

## SPF计算

> 每台路由器都可以根据LSDB计算出一棵以自己为根的、无环的、拥有最短路径的树，接着根据结果将路由加载入路由表

## 区域（Area ID）

> OSPF Area用于表示一个OSPF的区域，每个区域用一个区域号（Area ID）来标识

## 路由ID（Route r-ID）

> 用于在一个OSPF域中唯一地标识一台路由器，可以手动配置也可以自动配置

## OSPF应用

> 一般用于在核心交换机与汇聚交换机上运行OSPF，可以实现园区内的路由可达

## COST

> OSPF使用Cost（开销）作为路由的度量值

![image-20211021140718579](https://cdn.jsdelivr.net/gh/SC-WSKun/HexoStaticFile/img/image-20211021140718579.png)

## OSPF协议报文类型

- Hello：周期性发送，用来发现和维护OSPF邻居关系
- Database Description：描述本地LSDB的摘要信息，用于两台设备进行数据库同步
- Link State Request：用于向对方请求所需要的LSA。设备只有在OSPF邻居双方成功交换DD报文后才会向对方发送LSR报文
- Link State Update：用于向对方发送其所需要的LSA
- Link State ACK：用来对收到的LSA进行确认

## OSPF三大表

### 邻居表

> - OSPF在传递链路状态信息前，需先建立OSPF邻居关系
> - OSPF的邻居关系靠Hello报文建立
> - OSPF邻居表显示了OSPF路由器之间的邻居状态

查看邻居表的命令：

```
display ospf peer
```

### LSDB表

>- LSDB会保存自己产生的及从邻居收到的LSA信息
>- Type标识LSA的类型，AdvRouter标识发送LSA的路由器

查看LSDB表的命令：

```
display ospf lsdb
```

### OSPF路由表

> - OSPF路由表与IP路由表是不同的表
> - OSPF路由表包含Destination、Cost和NextHop等指导转发的信息

查看OSPF路由表的命令：

```
display ospf routing
```

## OSPF建立邻接关系

- 建立邻居关系
- 协商主/从
- 交互LSDB信息
- 同步LSDB

![image-20211021122942499](https://cdn.jsdelivr.net/gh/SC-WSKun/HexoStaticFile/img/image-20211021122942499.png)

## OSPF建立路由表

### OSPF网络类型

- Broadcast/BMA（广播式多路访问）：

  ![image-20211021125935522](https://cdn.jsdelivr.net/gh/SC-WSKun/HexoStaticFile/img/image-20211021125935522.png)

- NBMA（非广播式多路访问）：

  ![image-20211021130138051](https://cdn.jsdelivr.net/gh/SC-WSKun/HexoStaticFile/img/image-20211021130138051.png)

- P2MP（点到多点）：

  ![image-20211021131250248](https://cdn.jsdelivr.net/gh/SC-WSKun/HexoStaticFile/img/image-20211021131250248.png)

- P2P（点对点）：

  ![image-20211021125959036](https://cdn.jsdelivr.net/gh/SC-WSKun/HexoStaticFile/img/image-20211021125959036.png)

### 三种路由器身份

> 用于优化MA网络中OSPF邻接关系，解决LSA泛洪时产生的带宽浪费和设备资源损耗问题

- DR：指定路由器

- BDR：备用指定路由器

- DRother路由器

只允许DR、BDR与其他OSPF路由器建立邻接关系。DRother之间不会建立全毗邻的OSPF邻接关系，双方停滞在2-way状态

BDR会监控DR的状态，并在DR故障时接替位置

## OSPF多区域

> 解决单个OSPF区域导致的LSDB过于庞大路由计算困难以及拓扑变更时LSA全域泛洪和全网SPF重计算带来巨大负担的问题

- OSPF引入区域（Area）的概念，可以是OSPF支撑更大规模组网
- OSPF多区域的设计减小了LSA泛洪的范围
- 在区域边界可以做路由汇总，减小路由表规模
- 多区域提高了网络扩展性，有利于组件大规模的网络

## STUB区域

> 当一个OSPF区域处于整个自治系统边界，又不含其他路由协议时，就可以配置STUB区域

目的是减少OSPF的路由表规模。

STUB区域中的路由器会增加一条至ABR的默认路由条目，当ABR配置了完全末梢区域后，其他路由器的路由除了直连条目外只有这条默认路由，不会学习其他区域的路由条目。到其他区域的ABR通过ABR转发。  

##  NSSA区域

> 对STUB区域的扩充



## OSPF路由器类型

- 区域内路由器IR
- 区域边界路由器ABR
- 骨干路由器BR
- 自治系统边界路由器ASBR

![image-20211021140044999](https://cdn.jsdelivr.net/gh/SC-WSKun/HexoStaticFile/img/image-20211021140044999.png)

# NAT

> 对IP数据报文中的IP地址进行转换，一般部署在网络出口设备，例如路由器或防火墙上

## 优点

- 实现IP地址复用
- 地址转换过程对用户透明
- 对内网用户提供隐私保护
- 可实现对内部服务器的负载均衡

## 缺点

- 网络监控难度加大
- 限制某些具体应用

## NAT分类

- 地址池方式：源NAT
- Easy IP：源NAT
- 静态映射（NAT Server）：服务器映射

## 静态NAT

> 原理：每个私有地址都有一个与之对应并且固定的公有地址

### 静态NAT配置

- 方式一：

  接口视图下配置静态NAT

  ```
  nat static global {global-address} inside {host-address}
  ```

  global参数用于配置外部公有地址，inside参数用于配置内部私有地址

- 方式二：
  系统视图下配置静态NAT

  ```
  nat static global {global-address} inside {host-address}
  ```

  之后在具体的接口下开启静态NAT：

  `````
  nat static enable

## 动态NAT

> 原理：当内部主机访问外部网络时临时分配一个地址池中未使用的地址，并将该地址标记为***Ln Use***。当主机不再访问外部网络时回收分配的地址，重新标记为***Not Use***

### 配置动态NAT

1. 创建地址池

   ~~~
   nat address-group group-index start-address end-address
   ~~~

2. 配置地址转换的ACL规则

   ```
   acl number
   rule permit source source-address source-wildcard
   ```

   配置基础ACL，匹配需要进行动态转换的源地址范围

3. 接口视图下配置带地址池的NAT Outbound

   ~~~
   nat outbound acl-number address-group group-index [no-pat]
   ~~~

   接口下关联ACL与地址池进行动态地址转换，no-pat参数指定不进行端口转换

## NAPT(网络地址端口转换)

>从地址池中选择地址进行地址转换时，不止转换IP地址，同时**也会对端口号进行转换**，有效提高公有地址利用率

配置NAPT只需要在配置NAT时不带**no-pat**参数即可

现在默认应该为NAPT

## Easy-IP

> 实现原理和NAPT相同，同时转换IP地址、传输层端口，但是Easy IP的IP地址是固定的，即Easy-IP只能单纯通过端口来实现1到n的映射

## NAT Server

> 指定[公有地址 : 端口]与[私有地址 : 端口]的一对一映射关系，将内网服务器映射到公网，当私有网络中的服务器需要对公网提供服务时使用

## NAT ALG

> NAT ALG（应用级网关）是特定的应用协议的转换代理，可以完成应用层数据中携带的地址及端口号信息的转换。

![image-20211112212021225](https://cdn.jsdelivr.net/gh/SC-WSKun/HexoStaticFile/img/image-20211112212021225.png)

## 双向NAT技术

### 域内双向NAT

> 解决内网路由需要有外网主机源地址的路由的问题
>
> 解决内网用户跟内网服务器之间的通信



# 网络服务与应用

## FTP

> 采用典型的C/S架构，客户端与服务器端建立TCP连接之后即可实现文件上传下载

 传输模式：

- ASCII模式
- Binary模式

工作方式：

- 主动模式

  ![image-20211021222038529](https://cdn.jsdelivr.net/gh/SC-WSKun/HexoStaticFile/img/image-20211021222038529.png)

- 被动模式

  ![image-20211021222339853](https://cdn.jsdelivr.net/gh/SC-WSKun/HexoStaticFile/img/image-20211021222339853.png)

## TFTP

> TFTP以传输小文件为目标

- 使用UDP进行传输（端口号69）
- 无需认证
- 只能直接向服务器端请求某个文件或者上传某个文件，无法查看服务器端的文件目录

![image-20211022012247266](https://cdn.jsdelivr.net/gh/SC-WSKun/HexoStaticFile/img/image-20211022012247266.png)

## Telnet

> 可以用Telnet协议对设备进行管理，无需专用线缆直连设备的Console接口，只要IP地址可达、能够和设备的TCP 23端口通信即可

## 虚拟用户界面

Telnet所对应的用户界面类型为VTY

## DHCP

> 为解决传统的静态手动配置方式不足，可以实现网络动态合理地分配IP地址给主机使用



> DHCP使用C/S构架，主机无需配置，从服务器端获取地址可实现接入网络后即插即用

### DHCP的优点

- 统一管理
- 地址租期

### DHCP工作原理

![image-20211022132947997](https://cdn.jsdelivr.net/gh/SC-WSKun/HexoStaticFile/img/image-20211022132947997.png)

### DHCP租期更新

![image-20211022134139079](https://cdn.jsdelivr.net/gh/SC-WSKun/HexoStaticFile/img/image-20211022134139079.png)

如果在50%租期时客户端未得到原服务端的回应，则客户端在87.5%租期时会广播发送DHCP Request，任意一台DHCP服务器端都可回应，该过程称为重绑定

## HTTP

# IPV6

## 优势

- “无限”的地址空间
- 层次化的地址结构
- 即插即用
- 简化的报文头部
- 安全特性
- 移动性
- 增强的QoS特性

## IPV6基本包头

![image-20211109201947863](https://cdn.jsdelivr.net/gh/SC-WSKun/HexoStaticFile/img/image-20211109201947863.png)

## IPV6报文处理机制

![image-20211109202334818](https://cdn.jsdelivr.net/gh/SC-WSKun/HexoStaticFile/img/image-20211109202334818.png)

- 基本包头长度固定宁，**提升转发效率**
- 扩展头部实现其他需求，**术业有专攻**

## IPV6地址

- 长度为128bit。一般用冒号分割为8段，用16进制表示
- IPV6地址也可以用*IPV6/掩码长度*的方式来表示IPV6地址

## IPV6缩写规范

- 每组16bit党员中的前导0可以省略，但是如果全为0，必须保留至少一个“0”字符，拖尾的0不能被省略
- 一个或多个连续的16bit字符为0时，可用“::”表示，但整个IPV6地址缩写中只能有一个"::"

## IPV6地址分类

- 单播地址

  - 网络前缀：nbit

  - 接口标识：(128-n)bit ，相当于IPv4地址中的主机ID。

  - 常见单播地址：

    - GUA：可聚合全球单播地址，通常GUA的网络部分长度为64bit，接口标识也为64bit。

      全局路由前缀：由提供商指定给一个组织机构，一般至少45bit

    ![image-20211109225759598](https://cdn.jsdelivr.net/gh/SC-WSKun/HexoStaticFile/img/image-20211109225759598.png)

    - ULA：唯一本地地址，是IPv6的私网地址，只能够在内网中使用。该地址空间在IPv6公网中不可被路由，因此不能访问公网

      概括为：可以在内网被路由转发，但是不能访问公网

      既然IPv6有足够大的地址池，还要内网地址干嘛呢？注意，ULA是用来给企业或者个人免经过运营商申请获取公网IP就能自己组网用的，不是用来提供ULA，

    ![image-20211109232057829](https://cdn.jsdelivr.net/gh/SC-WSKun/HexoStaticFile/img/image-20211109232057829.png)

    - LLA：链路本地地址，是IPv6中另一种应用范围受限制的地址类型。LLA的有效范围是本地链路，前缀为FE80::/10

      概括为：只能在交换机连接的网络中转发，不可被路由转发

    ![image-20211109232208066](https://cdn.jsdelivr.net/gh/SC-WSKun/HexoStaticFile/img/image-20211109232208066.png)

- 组播地址

  - 被请求节点组播地址：主要用于邻居发现机制和地址重复检测功能。被请求节点组播地址的有效范围为本地链路范围。

    ![image-20211109234655623](https://cdn.jsdelivr.net/gh/SC-WSKun/HexoStaticFile/img/image-20211109234655623.png)

- 任播地址：任播地址表示一组网络接口。可以作为IPv6的源地址和目的地址。

![image-20211109235230399](https://cdn.jsdelivr.net/gh/SC-WSKun/HexoStaticFile/img/image-20211109235230399.png)

## NDP（邻居发现协议）

> NDP作用于数据链路层，负责在链路上发现其他节点和响应的IPv6地址，并确定可用路由和维护其他活动节点的信息可达性。
>
> **等效于IPv6中的ARP与ICMP路由器发现和重定向协议的结合，同时又增加了一些新的功能**

![image-20211110022513708](https://cdn.jsdelivr.net/gh/SC-WSKun/HexoStaticFile/img/image-20211110022513708.png)

### 五种ICMPv6消息类型

![image-20211110022552400](https://cdn.jsdelivr.net/gh/SC-WSKun/HexoStaticFile/img/image-20211110022552400.png)

- 路由器请求（RS）
- 路由器通告（RA）
- 邻居请求（NS）
- 邻居通告（NA）
- 重定向（R）

### IP动态分配过程（无状态）

主机启动时会发送RS消息到本地网段所有路由器组播地址 ff02::2，请求路由信息。

路由器收到RS后，要在0.5秒内返回RA回应，RA中的Prefix Length和Prefix联合决定了IPv6地址的网络前缀。

网络中的路由器会周期性的发送RA消息到本地网段所有节点组播地址ff02::1



### 地址解析

IPv6使用NS和NA报文来取代ARP在IPv4中的地址解析功能

![image-20211110101247874](https://cdn.jsdelivr.net/gh/SC-WSKun/HexoStaticFile/img/image-20211110101247874.png)

### DAD

无论通过何种方式配置了IPv6，主机或路由器都会：

- 通过ICMPv6报文进行DAD
- 仅当DAD通过之后才会使用该单播地址



## IPv6动态配置

> 有状态（例如：DHCPv6）：需要专门的DHCP服务器
>
> 无状态（例如：Radvd） ：直接通过接受路由器宣告的全局地址前缀，使用EUI64算法生成接口ID结合起来得到一个可聚集全局单播地址

有状态和无状态区别在于，地址池的计算，管理运行在服务端还是客户端

![image-20211110095933396](https://cdn.jsdelivr.net/gh/SC-WSKun/HexoStaticFile/img/image-20211110095933396.png)

# SDN

> 软件定义网络，通过将网络设备控制平面与数据平面分离，从而实现了网络控制平面的集中控制，为网络应用的创新提供了良好的支撑。本质上是为了让网络更加开放、灵活和简单。它的实现方式是为网络构建一个集中的大脑，通过全局视图集中控制，实现或业务快速部署、或流量调优、或网络业务开放等目标

## SDN的三个特征

- 转控分离
- 集中控制

- 开放可编程接口

## OpenFlow的基本概念

> OpenFlow是控制器与交换机之间的一种南向接口协议。他定义了三种类型的消息，Controller-to-switch、Asynchronous和Symmetric。每一种消息又包含了更多的子类型

![image-20211111134810105](https://cdn.jsdelivr.net/gh/SC-WSKun/HexoStaticFile/img/image-20211111134810105.png)

## OpenFlow转发方式和经典路由转发方式对比

![image-20211111135028727](https://cdn.jsdelivr.net/gh/SC-WSKun/HexoStaticFile/img/image-20211111135028727.png)

 
